<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>상품 목록</title>
</head>
<body>
<h2>상품 목록</h2>

<!-- 필터 영역 -->
<div style="margin-bottom: 20px;">
    <label>
        상위 카테고리:
        <select id="parent-category">
            <option value="">전체</option>
        </select>
    </label>
    <label style="margin-left: 10px;">
        하위 카테고리:
        <select id="child-category">
            <option value="">전체</option>
        </select>
    </label>
    <label style="margin-left: 10px;">
        검색어:
        <input type="text" id="searchInput" placeholder="상품명 또는 카테고리명">
    </label>
    <label style="margin-left: 10px;">
        최소가격:
        <input type="number" id="minPrice" placeholder="0">
    </label>
    <label style="margin-left: 10px;">
        최대가격:
        <input type="number" id="maxPrice" placeholder="1000000">
    </label>
    <label style="margin-left: 10px;">
        정렬:
        <select id="orderBy">
            <option value="asc">가격 오름차순</option>
            <option value="desc">가격 내림차순</option>
        </select>
    </label>
    <button onclick="searchProducts()">검색</button>
</div>

<!-- 상품 테이블 -->
<table border="1">
    <thead>
    <tr>
        <th>ID</th>
        <th>이름</th>
        <th>가격</th>
        <th>카테고리명</th>
    </tr>
    </thead>
    <tbody id="productTable"></tbody>
</table>

<script>
    let categories = [];

    async function fetchCategories() {
        const res = await fetch('/product/categories');
        if (!res.ok) {
            alert('카테고리 목록을 불러오지 못했습니다.');
            return;
        }
        categories = await res.json();

        const parentSelect = document.getElementById('parent-category');
        const parentCategories = categories.filter(cat => cat.parentId === null);

        parentCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.name;
            parentSelect.appendChild(option);
        });

        parentSelect.addEventListener('change', handleParentChange);
    }

    function handleParentChange(e) {
        const parentId = e.target.value ? parseInt(e.target.value) : null;
        const childSelect = document.getElementById('child-category');
        childSelect.innerHTML = '<option value="">전체</option>';

        const childCategories = categories.filter(cat => cat.parentId === parentId);
        childCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.name;
            childSelect.appendChild(option);
        });
    }

    async function fetchProducts() {
        const res = await fetch('/product/all');
        if (!res.ok) {
            alert('상품 목록을 불러오지 못했습니다.');
            return;
        }
        const allProducts = await res.json();
        renderProducts(allProducts);
    }

    function renderProducts(products) {
        const tbody = document.getElementById('productTable');
        tbody.innerHTML = '';

        products.forEach(p => {
            const tr = document.createElement('tr');

            const tdId = document.createElement('td');
            tdId.textContent = p.id;

            const tdName = document.createElement('td');
            const a = document.createElement('a');
            a.href = `/product/detail?id=${p.id}`;
            a.textContent = p.name;
            tdName.appendChild(a);

            const tdPrice = document.createElement('td');
            tdPrice.textContent = p.price;

            const tdCategory = document.createElement('td');
            tdCategory.textContent = p.categoryName;

            tr.appendChild(tdId);
            tr.appendChild(tdName);
            tr.appendChild(tdPrice);
            tr.appendChild(tdCategory);
            tbody.appendChild(tr);
        });
    }

    async function searchProducts() {
        const keyword = document.getElementById('searchInput').value.trim();
        const categoryId = document.getElementById('child-category').value;
        const minPrice = parseInt(document.getElementById('minPrice').value) || 0;
        const maxPrice = parseInt(document.getElementById('maxPrice').value) || 1000000;
        const orderBy = document.getElementById('orderBy').value;

        try {
            let url = "";

            if (keyword && categoryId) {
                url = `/product/search?keyword=${encodeURIComponent(keyword)}&categoryId=${categoryId}&minPrice=${minPrice}&maxPrice=${maxPrice}&orderBy=${orderBy}`;
            } else if (keyword && !categoryId) {
                url = `/product/search?keyword=${encodeURIComponent(keyword)}&minPrice=${minPrice}&maxPrice=${maxPrice}&orderBy=${orderBy}`;
            } else if (!keyword && categoryId) {
                url = `/product/category/${categoryId}`;
            } else {
                url = `/product/all`;
            }

            const res = await fetch(url);
            if (!res.ok) throw new Error('상품 조회 실패');

            const products = await res.json();
            renderProducts(products);
        } catch (err) {
            console.error(err);
            alert('상품 검색 중 오류 발생');
        }
    }

    fetchCategories();
    fetchProducts();
</script>
</body>
</html>