<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>주문하기</title>
</head>
<body>
<h1>주문하기</h1>

<form id="order-form">
    <label>받는 사람 이름: <input type="text" name="receiverName" required></label><br>
    <label>받는 사람 주소: <input type="text" name="receiverAddress" required></label><br><br>

    <div id="products">
        <h3>주문 상품</h3>
        <div class="product">
            <label>상품 ID: <input type="number" name="productId" required></label>
            <label>수량: <input type="number" name="count" required min="1"></label>
        </div>
    </div>
    <button type="button" onclick="addProduct()">상품 추가</button><br><br>

    <button type="submit">주문하기</button>
</form>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        const product = JSON.parse(localStorage.getItem("orderProduct"));
        if (product) {
            const productDiv = document.querySelector(".product");
            productDiv.querySelector('input[name="productId"]').value = product.productId;
            productDiv.querySelector('input[name="count"]').value = 1; // 기본 수량
        }
    });

    function addProduct() {
        const div = document.createElement('div');
        div.className = 'product';
        div.innerHTML = `
            <label>상품 ID: <input type="number" name="productId" required></label>
            <label>수량: <input type="number" name="count" required min="1"></label>
            <button type="button" onclick="this.parentElement.remove()">제거</button>
        `;
        document.getElementById('products').appendChild(div);
    }

    document.getElementById('order-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const productIds = formData.getAll('productId');
        const counts = formData.getAll('count');

        const orderProducts = productIds.map((id, idx) => ({
            productId: Number(id),
            count: Number(counts[idx])
        }));

        const data = {
            receiverName: formData.get('receiverName'),
            receiverAddress: formData.get('receiverAddress'),
            orderProducts: orderProducts
        };

        console.log("보내는 데이터:", data);

        const userInfo = JSON.parse(localStorage.getItem('userInfo'));
        const token = userInfo.accessToken;

        const res = await fetch('/order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });

        if (res.ok) {
            alert('주문이 완료되었습니다!');
            location.href = '/';
        } else {
            const errorMessage = await res.text();
            alert(errorMessage);
        }
    });
</script>
</body>
</html>