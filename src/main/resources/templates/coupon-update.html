<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>쿠폰 수정</title>
</head>
<body>
<h2>쿠폰 수정</h2>
<form id="updateCouponForm">
    <label>쿠폰명: <input type="text" name="name" id="name" required></label><br>
    <label>발급 수량: <input type="number" name="quantity" id="quantity" required></label><br>
    <label>유효기간 (예: 2025-12-31T23:59:59): <input type="text" name="expiredDate" id="expiredDate" required></label><br>
    <label>활성화 여부:
        <select name="isActive" id="isActive" required>
            <option value="true">활성화</option>
            <option value="false">비활성화</option>
        </select>
    </label><br>
    <label>최소 사용 금액: <input type="number" name="minimumMoney" id="minimumMoney" required></label><br>
    <label>할인 금액: <input type="number" name="discountPrice" id="discountPrice" required></label><br><br>
    <button type="submit">쿠폰 수정</button>
</form>

<script>
    const user = JSON.parse(localStorage.getItem("userInfo"));
    const urlParams = new URLSearchParams(window.location.search);
    const couponId = urlParams.get('id');

    async function loadCouponData() {
        const res = await fetch(`/coupon/detail/${couponId}`);
        if (res.ok) {
            const coupon = await res.json();
            console.log("서버에서 받은 isActive:", coupon.isActive);

            const form = document.forms["updateCouponForm"];
            form.name.value = coupon.name;
            form.quantity.value = coupon.quantity;
            form.expiredDate.value = coupon.expiredDate;
            form.isActive.value = coupon.isActive ? "true" : "false";
            form.minimumMoney.value = coupon.minimumMoney;
            form.discountPrice.value = coupon.discountPrice;

            // 값이 select에 제대로 들어갔는지 확인
            console.log("form.isActive.value 설정 후:", form.isActive.value);

        } else {
            alert("쿠폰 정보를 불러오지 못했습니다.");
        }
    }

    document.getElementById("updateCouponForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const form = e.target;
        console.log("submit 직전 isActive 값:", form.isActive.value);

        const data = {
            name: form.name.value,
            quantity: parseInt(form.quantity.value),
            expiredDate: form.expiredDate.value,
            isActive: form.isActive.value === "true",
            minimumMoney: parseInt(form.minimumMoney.value),
            discountPrice: parseInt(form.discountPrice.value)
        };

        console.log("전송할 데이터:", data);

        const token = user?.accessToken;

        const res = await fetch(`/admin/coupon/update/${couponId}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify(data)
        });

        if (res.ok) {
            alert("쿠폰이 수정되었습니다.");
            window.location.href = "/coupon/list";
        } else {
            const error = await res.text();
            alert("쿠폰 수정 실패: " + error);
        }
    });

    loadCouponData();
</script>
</body>
</html>